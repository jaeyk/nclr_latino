---
title: "EDA"
output:
  html_document:
    df_print: paged
---

# Import pkgs 

```{r}
# Import pkgs
pacman::p_load(
  pdftools,
  readtext,
  tidyverse,
  purrr,
  furrr,
  tm,
  here,
  tidytext, # text analysis 
  SnowballC, # stemming 
  textclean, # text preprocessing 
  ggthemes,
  wesanderson,
  text2vec, # word embedding 
  widyr,
  patchwork, # arranging ggplots
  ggpubr, 
  glue,
  reactable,
  zoo
)

theme_set(theme_clean())

source(here("functions", "utils.r"))
```

# Import files 

```{r eval = FALSE}
# File name list
filename <- list.files(here("raw_data", "nclr"))

asian_filename <- list.files(here("raw_data", "clean_magazines_txts"))
```

# Turn texts into a dataframe 

```{r eval = FALSE}
# Excluding codebook
filename <- filename[!str_detect(filename, "codebook")]

gidra <- asian_filename[str_detect(asian_filename, "Gidra")]

bridge <- asian_filename[str_detect(asian_filename, "Bridge")]
```

```{r}
# Mapping 
text_list <- map(here("raw_data", "nclr", filename), pdf_text)

# List into a data frame
df <- text_list %>%
  map_df(enframe, .id = "ListElement")

# Reformat filename
date_list <- gsub(".pdf", "", filename)

# for loop

for (i in seq(date_list)) {
  df$ListElement[df$ListElement == paste(i)] <- date_list[i]
}

# Rename and mutate
df <- df %>%
  rename(
    "date" = "ListElement",
    "page_number" = "name"
  ) %>% 
  mutate(date = str_replace_all(date, "_", "-"))

# Ignore page numbers and concatenate texts by date 
df <- df %>% 
  group_by(date) %>%
  summarise(value = paste(value, collapse = ","))

# Save the df
saveRDS(df, file = here("processed_data/nclr.Rdata"))
```

```{r}
gidra_text <- map_dfr(here("raw_data", "clean_magazines_txts", gidra), parse_text)

bridge_text <- map_dfr(here("raw_data", "clean_magazines_txts", bridge), parse_text)

asian_text <- bind_rows(gidra_text, bridge_text)

# Save the asian_text
saveRDS(asian_text, file = here("processed_data/asian.Rdata"))
```

```{r}
# Load the df 
df <- readRDS(here("processed_data/nclr.Rdata"))

asian_text <- readRDS(here("processed_data/asian.Rdata"))

new_date_df <- df %>% 
  separate(date, into = c("year", "month"), "-") %>%
  select(year, month)

new_date_df <- glue("{new_date_df$year}-{new_date_df$month}")
new_date_asian <- glue("{asian_text$year}-{asian_text$month}")

df$date <- zoo::as.yearmon(new_date_df)
asian_text$date <- zoo::as.yearmon(new_date_asian)
```

# Preprocessing 

```{r eval = FALSE}
df <- clean_text(df)
asian_text <- clean_text(asian_text)

# Call stop words dictionary 
data("stop_words")
```

# Count words 

```{r eval = FALSE}
tf_idf_nclr <- get_word_count(df, stem = FALSE)
tf_idf_gidra <- get_word_count(asian_text %>%
                                 filter(source == "Gidra"), stem = FALSE)
tf_idf_bridge <- get_word_count(asian_text %>%
                                 filter(source != "Gidra"), stem = FALSE)

# Save the objects
save(df, tf_idf_nclr,
     asian_text, tf_idf_gidra, tf_idf_bridge, 
     file = here("processed_data/processed_text.Rdata"))
```

```{r}
#load(file = here("processed_data/processed_text.Rdata"))

tf_idf <- bind_rows(
  mutate(tf_idf_nclr, group = "NCLR"), 
  mutate(tf_idf_gidra, group = "Gidra"),
  mutate(tf_idf_bridge, group = "Bridge"))
```

# Plotting 

```{r}
theme_set(theme_clean())

ggarrange(plot_track_keyword(tf_idf, "absence|representation|visibility"), plot_track_keyword(tf_idf, "census|data|statistics"), ncol = 1, nrow = 2)

ggsave(here("outputs", "desc_visible.png"), width = 8)

ggarrange(plot_track_keyword(tf_idf, "discrimination|prejudice|oppression|racism|poverty"), plot_track_keyword(tf_idf, "heritage|identity|tradition"), plot_track_keyword(tf_idf, "power|struggle|unity")
, ncol = 1, nrow = 3)

ggsave(here("outputs", "desc_claim_marginal.png"), height = 12, width = 10)

ggarrange(plot_track_keyword(tf_idf, "asian|asians"), plot_track_keyword(tf_idf, "hispanic|mexican|puerto|chicano|spanish"), ncol = 1, nrow = 2)

ggsave(here("outputs", "desc_asian_latino.png"), width = 12)

ggarrange(plot_track_keyword(tf_idf, "white|whites"), plot_track_keyword(tf_idf, "black|blacks"), ncol = 1, nrow = 2)

ggsave(here("outputs", "desc_white_black.png"))
```
 
```{r eval = FALSE}
knitr::purl(input = here("code", "01_EDA.Rmd"),
            output = here("code", "01_EDA.r"))
```